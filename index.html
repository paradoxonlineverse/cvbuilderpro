<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Builder</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <!-- HTML2Canvas and jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .cv-preview {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        .profile-photo-preview {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 50%;
        }
        @media (max-width: 768px) {
            .cv-preview > div {
                flex-direction: column;
            }
            .cv-preview .md\\:w-1\\/3,
            .cv-preview .md\\:w-2\\/3 {
                width: 100%;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- Header -->
    <header class="bg-blue-600 text-white py-4">
        <div class="container mx-auto px-4">
            <h1 class="text-2xl font-bold">CV Builder</h1>
        </div>
    </header>
    
    <!-- Advertisement -->
    <div class="text-center py-4">
        <script type="text/javascript"> 
            atOptions = { 
                'key' : 'fab4e7b7e23b71f494d56a94707bfd06', 
                'format' : 'iframe', 
                'height' : 60, 
                'width' : 468, 
                'params' : {} 
            }; 
        </script> 
        <script type="text/javascript" src="//www.highperformanceformat.com/fab4e7b7e23b71f494d56a94707bfd06/invoke.js"></script>
    </div>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Toolbar -->
            <div class="bg-gray-100 p-4 flex justify-between items-center border-b">
                <div class="flex space-x-1 bg-white rounded overflow-hidden shadow-sm">
                    <button id="edit-mode-btn" class="px-4 py-2 bg-blue-600 text-white">
                        Edit
                    </button>
                    <button id="preview-mode-btn" class="px-4 py-2 text-gray-700 flex items-center">
                        <i data-lucide="eye" class="w-4 h-4 mr-1"></i> Preview
                    </button>
                </div>
                
                <div class="flex space-x-2">
                    <button id="reset-cv" class="bg-red-600 text-white px-4 py-2 rounded flex items-center">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-1"></i> Reset
                    </button>
                    <button id="download-cv-btn" class="bg-green-600 text-white px-4 py-2 rounded flex items-center">
                        <i data-lucide="download" class="w-4 h-4 mr-1"></i> Download CV
                    </button>
                </div>
            </div>
            
            <!-- Edit Mode -->
            <div id="edit-mode">
                <!-- Section Tabs -->
                <div class="flex border-b" role="tablist">
                    <button data-tab="personal" class="tab-btn px-4 py-3 font-medium border-b-2 border-blue-600 text-blue-600" role="tab" aria-selected="true" aria-controls="personal-section">
                        Personal Info
                    </button>
                    <button data-tab="education" class="tab-btn px-4 py-3 font-medium text-gray-600" role="tab" aria-selected="false" aria-controls="education-section">
                        Education
                    </button>
                    <button data-tab="experience" class="tab-btn px-4 py-3 font-medium text-gray-600" role="tab" aria-selected="false" aria-controls="experience-section">
                        Experience
                    </button>
                    <button data-tab="skills" class="tab-btn px-4 py-3 font-medium text-gray-600" role="tab" aria-selected="false" aria-controls="skills-section">
                        Skills
                    </button>
                </div>
                
                <!-- Form Content -->
                <div class="p-6">
                    <!-- Personal Info Form -->
                    <div id="personal-section" class="tab-content space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">First Name</label>
                                <input type="text" name="firstName" class="cv-field w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Last Name</label>
                                <input type="text" name="lastName" class="cv-field w-full p-2 border rounded" required>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Profession</label>
                            <input type="text" name="profession" class="cv-field w-full p-2 border rounded">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Email</label>
                                <input type="email" name="email" class="cv-field w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Phone</label>
                                <input type="text" name="phone" class="cv-field w-full p-2 border rounded" pattern="\+?\d{10,15}" title="Enter a valid phone number">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Address</label>
                            <input type="text" name="address" class="cv-field w-full p-2 border rounded">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Profile Photo</label>
                            <input type="file" id="profile-photo" accept="image/*" class="w-full p-2 border rounded">
                            <div id="photo-preview" class="mt-2"></div>
                            <button id="remove-photo" class="mt-2 text-red-500 hidden">Remove Photo</button>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Professional Summary</label>
                            <textarea name="summary" class="cv-field w-full p-2 border rounded h-32" spellcheck="true"></textarea>
                        </div>
                    </div>
                    
                    <!-- Education Form -->
                    <div id="education-section" class="tab-content hidden space-y-6">
                        <div id="education-items"></div>
                        <button id="add-education" class="flex items-center text-blue-600 font-medium">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Add Education
                        </button>
                    </div>
                    
                    <!-- Experience Form -->
                    <div id="experience-section" class="tab-content hidden space-y-6">
                        <div id="experience-items"></div>
                        <button id="add-experience" class="flex items-center text-blue-600 font-medium">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Add Experience
                        </button>
                    </div>
                    
                    <!-- Skills Form -->
                    <div id="skills-section" class="tab-content hidden space-y-6">
                        <div id="skills-items"></div>
                        <button id="add-skill" class="flex items-center text-blue-600 font-medium">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Add Skill
                        </button>
                    </div>
                    
                    <div class="mt-6 text-right">
                        <button id="preview-btn" class="bg-blue-600 text-white px-4 py-2 rounded flex items-center ml-auto">
                            <i data-lucide="eye" class="w-4 h-4 mr-1"></i> Preview CV
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Preview Mode -->
            <div id="preview-mode" class="p-6 bg-gray-50 hidden">
                <div id="cv-preview" class="max-w-4xl mx-auto bg-white p-8 shadow-lg cv-preview"></div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container mx-auto px-4 text-center">
            <p>Â© 2025 CV Builder. All rights reserved.</p>
        </div>
    </footer>

    <!-- Templates -->
    <template id="education-template">
        <div class="education-item p-4 border rounded bg-gray-50 relative">
            <button class="remove-education absolute right-2 top-2 text-red-500" aria-label="Remove education entry">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Institution</label>
                    <input type="text" name="institution" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Degree</label>
                    <input type="text" name="degree" class="w-full p-2 border rounded">
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Field of Study</label>
                <input type="text" name="field" class="w-full p-2 border rounded">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Start Date</label>
                    <input type="text" name="startDate" class="w-full p-2 border rounded" placeholder="MM/YYYY" pattern="\d{2}/\d{4}" title="Enter date in MM/YYYY format">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">End Date</label>
                    <input type="text" name="endDate" class="w-full p-2 border rounded" placeholder="MM/YYYY or Present" pattern="(\d{2}/\d{4}|Present)" title="Enter date in MM/YYYY format or 'Present'">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Description</label>
                <textarea name="description" class="w-full p-2 border rounded h-24" spellcheck="true"></textarea>
            </div>
        </div>
    </template>

    <template id="experience-template">
        <div class="experience-item p-4 border rounded bg-gray-50 relative">
            <button class="remove-experience absolute right-2 top-2 text-red-500" aria-label="Remove experience entry">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Company</label>
                    <input type="text" name="company" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Position</label>
                    <input type="text" name="position" class="w-full p-2 border rounded">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Start Date</label>
                    <input type="text" name="startDate" class="w-full p-2 border rounded" placeholder="MM/YYYY" pattern="\d{2}/\d{4}" title="Enter date in MM/YYYY format">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">End Date</label>
                    <input type="text" name="endDate" class="w-full p-2 border rounded" placeholder="MM/YYYY or Present" pattern="(\d{2}/\d{4}|Present)" title="Enter date in MM/YYYY format or 'Present'">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Description</label>
                <textarea name="description" class="w-full p-2 border rounded h-24" spellcheck="true"></textarea>
            </div>
        </div>
    </template>

    <template id="skill-template">
        <div class="skill-item p-4 border rounded bg-gray-50 flex items-center">
            <div class="flex-grow">
                <label class="block text-sm font-medium mb-1">Skill Name</label>
                <input type="text" name="name" class="w-full p-2 border rounded" required>
            </div>
            <div class="ml-4 flex-grow">
                <label class="block text-sm font-medium mb-1">Proficiency (1-5)</label>
                <input type="range" name="level" min="1" max="5" value="3" class="w-full">
                <div class="flex justify-between text-xs">
                    <span>Beginner</span>
                    <span>Expert</span>
                </div>
            </div>
            <button class="remove-skill ml-4 text-red-500 self-start mt-6" aria-label="Remove skill entry">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
        </div>
    </template>

    <script>
        // Utility to sanitize HTML to prevent XSS
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, (m) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&apos;'
            })[m]);
        }

        // Utility to sanitize file names
        function sanitizeFileName(name) {
            return name.replace(/[^a-zA-Z0-9\s_-]/g, '').replace(/\s+/g, '_');
        }

        // Function to initialize Lucide icons with retry limit
        function initializeIcons(retryCount = 0, maxRetries = 10) {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            } else if (retryCount < maxRetries) {
                console.warn('Lucide library not loaded. Retrying in 100ms...');
                setTimeout(() => initializeIcons(retryCount + 1, maxRetries), 100);
            } else {
                console.error('Failed to load Lucide library after multiple attempts.');
            }
        }

        // CV Data Model
        const cvData = {
            personal: {
                firstName: '',
                lastName: '',
                profession: '',
                email: '',
                phone: '',
                address: '',
                summary: '',
                photo: ''
            },
            education: [],
            experience: [],
            skills: []
        };

        // Load data from localStorage if available
        function loadSavedData() {
            const savedData = localStorage.getItem('cvData');
            if (savedData) {
                Object.assign(cvData, JSON.parse(savedData));
                Object.keys(cvData.personal).forEach(key => {
                    if (key !== 'photo') {
                        const input = document.querySelector(`[name="${key}"]`);
                        if (input) input.value = cvData.personal[key];
                    }
                });
                if (cvData.personal.photo) {
                    const photoPreview = document.getElementById('photo-preview');
                    photoPreview.innerHTML = `<img src="${cvData.personal.photo}" class="profile-photo-preview" alt="Profile Photo">`;
                    document.getElementById('remove-photo').classList.remove('hidden');
                }
                cvData.education.forEach(edu => addEducationItem(edu));
                cvData.experience.forEach(exp => addExperienceItem(exp));
                cvData.skills.forEach(skill => addSkillItem(skill));
            } else {
                addEducationItem();
                addExperienceItem();
                addSkillItem();
            }
        }

        // Save data to localStorage with feedback
        let saveTimeout;
        function saveData() {
            if (cvData.personal.photo.length > 1024 * 1024) {
                alert('Profile photo is too large for persistent storage. Please re-upload when resuming.');
                cvData.personal.photo = '';
                document.getElementById('photo-preview').innerHTML = '';
                document.getElementById('remove-photo').classList.add('hidden');
            }
            localStorage.setItem('cvData', JSON.stringify(cvData));
            const saveIndicator = document.createElement('div');
            saveIndicator.textContent = 'Saved';
            saveIndicator.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded';
            document.body.appendChild(saveIndicator);
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveIndicator.remove(), 2000);
        }

        // Handle photo upload
        const profilePhotoInput = document.getElementById('profile-photo');
        const photoPreview = document.getElementById('photo-preview');
        const removePhotoBtn = document.getElementById('remove-photo');

        profilePhotoInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    cvData.personal.photo = e.target.result;
                    photoPreview.innerHTML = `<img src="${cvData.personal.photo}" class="profile-photo-preview" alt="Profile Photo">`;
                    removePhotoBtn.classList.remove('hidden');
                    saveData();
                };
                reader.readAsDataURL(file);
            }
        });

        removePhotoBtn.addEventListener('click', () => {
            cvData.personal.photo = '';
            photoPreview.innerHTML = '';
            removePhotoBtn.classList.add('hidden');
            profilePhotoInput.value = '';
            saveData();
        });

        // Tab Functionality
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                tabButtons.forEach(b => {
                    b.classList.remove('border-blue-600', 'text-blue-600');
                    b.classList.add('text-gray-600');
                    b.setAttribute('aria-selected', 'false');
                });
                btn.classList.remove('text-gray-600');
                btn.classList.add('border-blue-600', 'text-blue-600');
                btn.setAttribute('aria-selected', 'true');
                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tabName}-section`).classList.remove('hidden');
            });
        });

        // Mode Switching (Edit/Preview)
        const editModeBtn = document.getElementById('edit-mode-btn');
        const previewModeBtn = document.getElementById('preview-mode-btn');
        const previewBtn = document.getElementById('preview-btn');
        const editMode = document.getElementById('edit-mode');
        const previewMode = document.getElementById('preview-mode');

        function switchToEditMode() {
            editMode.classList.remove('hidden');
            previewMode.classList.add('hidden');
            editModeBtn.classList.add('bg-blue-600', 'text-white');
            editModeBtn.classList.remove('text-gray-700');
            previewModeBtn.classList.remove('bg-blue-600', 'text-white');
            previewModeBtn.classList.add('text-gray-700');
        }

        function switchToPreviewMode() {
            updatePreview();
            editMode.classList.add('hidden');
            previewMode.classList.remove('hidden');
            editModeBtn.classList.remove('bg-blue-600', 'text-white');
            editModeBtn.classList.add('text-gray-700');
            previewModeBtn.classList.add('bg-blue-600', 'text-white');
            previewModeBtn.classList.remove('text-gray-700');
        }

        editModeBtn.addEventListener('click', switchToEditMode);
        previewModeBtn.addEventListener('click', switchToPreviewMode);
        previewBtn.addEventListener('click', switchToPreviewMode);

        // Education Section
        function addEducationItem(data = null) {
            const educationItems = document.getElementById('education-items');
            const template = document.getElementById('education-template');
            const clone = document.importNode(template.content, true);
            const item = clone.querySelector('.education-item');
            const educationId = Date.now();
            item.dataset.id = educationId;

            if (!data) {
                data = {
                    id: educationId,
                    institution: '',
                    degree: '',
                    field: '',
                    startDate: '',
                    endDate: '',
                    description: ''
                };
                cvData.education.push(data);
            } else {
                data.id = educationId;
            }

            if (data) {
                const inputs = item.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    const fieldName = input.getAttribute('name');
                    if (data[fieldName] !== undefined) {
                        input.value = data[fieldName];
                    }
                });
            }

            const removeBtn = item.querySelector('.remove-education');
            removeBtn.addEventListener('click', () => {
                if (cvData.education.length > 1) {
                    cvData.education = cvData.education.filter(edu => edu.id !== parseInt(item.dataset.id));
                    item.remove();
                    saveData();
                } else {
                    alert('At least one education entry is required.');
                }
            });

            const inputs = item.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    const fieldName = input.getAttribute('name');
                    if (['startDate', 'endDate'].includes(fieldName) && input.value && !/(\d{2}\/\d{4}|Present)/.test(input.value)) {
                        input.setCustomValidity('Please use MM/YYYY format or "Present"');
                    } else {
                        input.setCustomValidity('');
                        const eduItem = cvData.education.find(edu => edu.id === parseInt(item.dataset.id));
                        if (eduItem) {
                            eduItem[fieldName] = input.value;
                            saveData();
                        }
                    }
                });
            });

            educationItems.appendChild(item);
            initializeIcons();
        }

        document.getElementById('add-education').addEventListener('click', () => {
            addEducationItem();
        });

        // Experience Section
        function addExperienceItem(data = null) {
            const experienceItems = document.getElementById('experience-items');
            const template = document.getElementById('experience-template');
            const clone = document.importNode(template.content, true);
            const item = clone.querySelector('.experience-item');
            const experienceId = Date.now();
            item.dataset.id = experienceId;

            if (!data) {
                data = {
                    id: experienceId,
                    company: '',
                    position: '',
                    startDate: '',
                    endDate: '',
                    description: ''
                };
                cvData.experience.push(data);
            } else {
                data.id = experienceId;
            }

            if (data) {
                const inputs = item.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    const fieldName = input.getAttribute('name');
                    if (data[fieldName] !== undefined) {
                        input.value = data[fieldName];
                    }
                });
            }

            const removeBtn = item.querySelector('.remove-experience');
            removeBtn.addEventListener('click', () => {
                if (cvData.experience.length > 1) {
                    cvData.experience = cvData.experience.filter(exp => exp.id !== parseInt(item.dataset.id));
                    item.remove();
                    saveData();
                } else {
                    alert('At least one experience entry is required.');
                }
            });

            const inputs = item.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    const fieldName = input.getAttribute('name');
                    if (['startDate', 'endDate'].includes(fieldName) && input.value && !/(\d{2}\/\d{4}|Present)/.test(input.value)) {
                        input.setCustomValidity('Please use MM/YYYY format or "Present"');
                    } else {
                        input.setCustomValidity('');
                        const expItem = cvData.experience.find(exp => exp.id === parseInt(item.dataset.id));
                        if (expItem) {
                            expItem[fieldName] = input.value;
                            saveData();
                        }
                    }
                });
            });

            experienceItems.appendChild(item);
            initializeIcons();
        }

        document.getElementById('add-experience').addEventListener('click', () => {
            addExperienceItem();
        });

        // Skills Section
        function addSkillItem(data = null) {
            const skillsItems = document.getElementById('skills-items');
            const template = document.getElementById('skill-template');
            const clone = document.importNode(template.content, true);
            const item = clone.querySelector('.skill-item');
            const skillId = Date.now();
            item.dataset.id = skillId;

            if (!data) {
                data = {
                    id: skillId,
                    name: '',
                    level: 3
                };
                cvData.skills.push(data);
            } else {
                data.id = skillId;
            }

            if (data) {
                const inputs = item.querySelectorAll('input');
                inputs.forEach(input => {
                    const fieldName = input.getAttribute('name');
                    if (data[fieldName] !== undefined) {
                        input.value = data[fieldName];
                    }
                });
            }

            const removeBtn = item.querySelector('.remove-skill');
            removeBtn.addEventListener('click', () => {
                if (cvData.skills.length > 1) {
                    cvData.skills = cvData.skills.filter(skill => skill.id !== parseInt(item.dataset.id));
                    item.remove();
                    saveData();
                } else {
                    alert('At least one skill entry is required.');
                }
            });

            const inputs = item.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    const fieldName = input.getAttribute('name');
                    const skillItem = cvData.skills.find(skill => skill.id === parseInt(item.dataset.id));
                    if (skillItem) {
                        skillItem[fieldName] = input.type === 'range' ? parseInt(input.value) : input.value;
                        saveData();
                    }
                });
            });

            skillsItems.appendChild(item);
            initializeIcons();
        }

        document.getElementById('add-skill').addEventListener('click', () => {
            addSkillItem();
        });

        // Update personal info data
        document.querySelectorAll('.cv-field').forEach(input => {
            input.addEventListener('input', () => {
                const fieldName = input.getAttribute('name');
                cvData.personal[fieldName] = input.value;
                saveData();
            });
        });

        // Generate CV Preview
        function updatePreview() {
            const previewContainer = document.getElementById('cv-preview');
            const { personal, education, experience, skills } = cvData;

            let html = `
                <div class="flex flex-col md:flex-row">
                    <div class="md:w-1/3 bg-blue-50 p-6">
                        ${personal.photo ? `
                            <div class="mb-6 text-center">
                                <img src="${personal.photo}" class="w-32 h-32 rounded-full mx-auto object-cover" alt="Profile Photo">
                            </div>
                        ` : ''}
                        <div class="mb-6">
                            <h1 class="text-2xl font-bold text-gray-800">${escapeHTML(personal.firstName)} ${escapeHTML(personal.lastName)}</h1>
                            ${personal.profession ? `<h2 class="text-lg text-gray-600 mt-1">${escapeHTML(personal.profession)}</h2>` : ''}
                        </div>
                        <div class="mb-6">
                            <h3 class="text-md font-semibold mb-2 text-gray-800">Contact</h3>
                            <div class="text-sm text-gray-700 space-y-1">
                                ${personal.email ? `<div><i data-lucide="mail" class="w-4 h-4 inline mr-2"></i>${escapeHTML(personal.email)}</div>` : ''}
                                ${personal.phone ? `<div><i data-lucide="phone" class="w-4 h-4 inline mr-2"></i>${escapeHTML(personal.phone)}</div>` : ''}
                                ${personal.address ? `<div><i data-lucide="map-pin" class="w-4 h-4 inline mr-2"></i>${escapeHTML(personal.address)}</div>` : ''}
                            </div>
                        </div>
                        ${skills.some(skill => skill.name) ? `
                            <div>
                                <h3 class="text-md font-semibold mb-2 text-gray-800">Skills</h3>
                                <div class="space-y-2">
                                    ${skills.filter(skill => skill.name).map(skill => `
                                        <div>
                                            <div class="text-sm text-gray-700">${escapeHTML(skill.name)}</div>
                                            <div class="flex mt-1">
                                                ${Array(5).fill().map((_, i) => `
                                                    <div class="h-2 w-6 mr-1 rounded ${i < skill.level ? 'bg-blue-600' : 'bg-gray-300'}"></div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="md:w-2/3 p-6">
                        ${personal.summary ? `
                            <div class="mb-8">
                                <h3 class="text-lg font-semibold mb-2 text-gray-800 border-b pb-1">Professional Summary</h3>
                                <p class="text-sm text-gray-700 leading-relaxed">${escapeHTML(personal.summary)}</p>
                            </div>
                        ` : ''}
                        ${experience.some(exp => exp.company || exp.position) ? `
                            <div class="mb-8">
                                <h3 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-1">Work Experience</h3>
                                ${experience.filter(exp => exp.company || exp.position).map(exp => `
                                    <div class="mb-4">
                                        <div class="flex justify-between">
                                            <div>
                                                ${exp.position ? `<h4 class="font-semibold text-gray-800">${escapeHTML(exp.position)}</h4>` : ''}
                                                ${exp.company ? `<div class="text-sm text-gray-600">${escapeHTML(exp.company)}</div>` : ''}
                                            </div>
                                            ${(exp.startDate || exp.endDate) ? `
                                                <div class="text-sm text-gray-500">
                                                    ${escapeHTML(exp.startDate)} - ${escapeHTML(exp.endDate)}
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${exp.description ? `<p class="mt-2 text-sm text-gray-700">${escapeHTML(exp.description)}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${education.some(edu => edu.institution || edu.degree) ? `
                            <div>
                                <h3 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-1">Education</h3>
                                ${education.filter(edu => edu.institution || edu.degree).map(edu => `
                                    <div class="mb-4">
                                        <div class="flex justify-between">
                                            <div>
                                                ${edu.degree ? `<h4 class="font-semibold text-gray-800">${escapeHTML(edu.degree)}${edu.field ? `, ${escapeHTML(edu.field)}` : ''}</h4>` : ''}
                                                ${edu.institution ? `<div class="text-sm text-gray-600">${escapeHTML(edu.institution)}</div>` : ''}
                                            </div>
                                            ${(edu.startDate || edu.endDate) ? `
                                                <div class="text-sm text-gray-500">
                                                    ${escapeHTML(edu.startDate)} - ${escapeHTML(edu.endDate)}
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${edu.description ? `<p class="mt-2 text-sm text-gray-700">${escapeHTML(edu.description)}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            previewContainer.innerHTML = html;
            initializeIcons();
        }

        // Download CV functionality
        document.getElementById('download-cv-btn').addEventListener('click', () => {
            updatePreview();
            if (editMode.classList.contains('hidden') === false) {
                switchToPreviewMode();
            }
            const cvElement = document.getElementById('cv-preview');
            const wrapper = document.createElement('div');
            const cvRect = cvElement.getBoundingClientRect();
            wrapper.style.width = `${cvRect.width}px`;
            wrapper.style.backgroundColor = 'white';
            wrapper.style.padding = '20mm';
            wrapper.style.position = 'absolute';
            wrapper.style.left = '-9999px';
            wrapper.innerHTML = cvElement.innerHTML;
            document.body.appendChild(wrapper);

            const loadingMsg = document.createElement('div');
            loadingMsg.textContent = 'Generating PDF...';
            loadingMsg.className = 'fixed top-0 left-0 w-full bg-blue-600 text-white text-center py-2 z-50';
            document.body.appendChild(loadingMsg);

            setTimeout(() => {
                html2canvas(wrapper, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    let pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const imgData = canvas.toDataURL('image/png');

                    if (pdfHeight > pageHeight) {
                        let heightLeft = pdfHeight;
                        let position = 0;
                        while (heightLeft > 0) {
                            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                            heightLeft -= pageHeight;
                            position -= pageHeight;
                            if (heightLeft > 0) pdf.addPage();
                        }
                    } else {
                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    }

                    const fileName = `${sanitizeFileName(cvData.personal.firstName)}_${sanitizeFileName(cvData.personal.lastName)}_CV.pdf` || 'cv.pdf';
                    pdf.save(fileName);
                    document.body.removeChild(wrapper);
                    document.body.removeChild(loadingMsg);
                }).catch(error => {
                    console.error('Error generating PDF:', error);
                    alert('There was an error generating your PDF. Please try again.');
                    document.body.removeChild(wrapper);
                    document.body.removeChild(loadingMsg);
                });
            }, 100);
        });

        // Reset CV functionality
        document.getElementById('reset-cv').addEventListener('click', () => {
            if (confirm('Are you sure you want to reset your CV? This cannot be undone.')) {
                localStorage.removeItem('cvData');
                location.reload();
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedData();
            document.querySelectorAll('.cv-field').forEach(input => {
                const fieldName = input.getAttribute('name');
                input.value = cvData.personal[fieldName] || '';
            });
            initializeIcons();
        });
    </script>
</body>
</html>